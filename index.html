<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Locked Pet's Dashboard</title>
<style>
  :root{
    --bg:#0f0f12;
    --card:#1a1a1f;
    --ink:#eaeaf0;
    --muted:#9aa0a6;
    --accent:#ff3366;
    --accent2:#cc0033;
    --ok:#22c55e;
    --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
    background:var(--bg);
    color:var(--ink);
    line-height:1.45;
  }
  header{
    padding:20px 16px;
    text-align:center;
    position:sticky;top:0;background:linear-gradient(0deg, rgba(15,15,18,0.2), var(--bg) 40%);
    z-index:10;
    border-bottom:1px solid #212129;
  }
  h1{margin:6px 0 0 0;font-size:1.4rem}
  .wrap{
    max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px;
    grid-template-columns:1fr;
  }
  @media(min-width:980px){
    .wrap{grid-template-columns:1.1fr 0.9fr;}
  }
  .card{
    background:var(--card);
    border:1px solid #23232b;
    border-radius:16px;
    padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,0.25);
  }
  .muted{color:var(--muted);font-size:0.9rem}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:4px 10px;border-radius:999px;background:#121219;border:1px solid #2a2a33}
  .progress-outer{
    width:100%;height:20px;border-radius:12px;background:#11131a;border:1px solid #2a2a33;overflow:hidden
  }
  .progress-inner{
    height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .35s;
  }
  .status{font-weight:600;margin-left:6px}
  button, input, textarea, select{
    background:#13131a;border:1px solid #2a2a33;color:var(--ink);
    border-radius:10px;padding:10px 12px;font-size:1rem
  }
  button{cursor:pointer}
  button:hover{filter:brightness(1.05)}
  textarea{width:100%;min-height:90px;resize:vertical}
  ul.rules{list-style:none;padding:0;margin:0;display:grid;gap:8px}
  ul.rules li{background:#13141b;border:1px solid #2a2a33;border-radius:10px;padding:10px 12px}
  .tasks{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .task{display:flex;gap:8px;align-items:center;background:#12131a;border:1px solid #2a2a33;border-radius:10px;padding:10px}
  .task input[type="checkbox"]{transform:scale(1.2)}
  /* Calendar */
  .cal{
    --g:12px;
    display:grid; gap:var(--g);
  }
  .cal header{position:unset;background:unset;border:none;padding:0;text-align:left}
  .cal .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .cal .bar h3{margin:0}
  .cal .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal .dow{color:var(--muted);text-align:center;font-size:0.85rem}
  .cal .cell{
    height:80px;background:#12131a;border:1px solid #2a2a33;border-radius:10px;padding:6px;
    display:flex;flex-direction:column;justify-content:space-between
  }
  .cal .num{font-weight:600;color:#d7d7de}
  .cal .marks{display:flex;gap:4px;flex-wrap:wrap}
  .chip{font-size:.75rem;border-radius:999px;padding:2px 6px;border:1px solid #2a2a33}
  .chip.done{background:rgba(34,197,94,.12);border-color:#214d33}
  .chip.missed{background:rgba(245,158,11,.12);border-color:#4d3a21}
  .chip.lock{background:rgba(255,51,102,.12);border-color:#4d1d2b}
  .chip.released{background:rgba(96, 0, 250, 0.315);border-color:#0a0041}
  .chip.unlocked{background:rgb(57, 69, 240);border-color:#0016db}
  .center{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .small{font-size:.9rem}
  .right{margin-left:auto}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace;font-size:.85rem;background:#0e0e12;border:1px solid #2a2a33;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
  <header>
    <div class="row center">
      <div class="pill">Locked Pet's Dashboard</div>
      <div class="pill">Mode: <span id="modeLabel" class="status">Locked Pet</span></div>
      <button id="toggleMode" title="Enter a passphrase to enable Keyholder updates">Keyholder Mode</button>
      <button id="subModeBtn" >Locked Pet Mode</button>
    </div>
    <h1>Locked Pet's Dashboard</h1>
  </header>
<div id="serverMsg" class="banner" style="display:none;max-width:950px;margin:10px auto"></div>

  <div class="wrap">
    <!-- LEFT COLUMN -->
    <section class="card">
      <h2>Calendar</h2>
      <div class="muted small">Tap a day to mark: <span class="chip done">Done</span> / <span class="chip missed">Missed</span> / <span class="chip lock">Locked</span> / <span class="chip released">Released</span> / <span class="chip unlocked">Unlocked</span>.</div>
      <div class="cal" id="calendar">
        <div class="bar">
          <button id="prevBtn">‚Üê Prev</button>
          <h3 id="monthLabel">Month YYYY</h3>
          <button id="nextBtn">Next ‚Üí</button>
        </div>
        <div class="grid" id="dowRow"></div>
        <div class="grid" id="dayGrid"></div>
      </div>
    </section>

    <!-- RIGHT COLUMN -->
    <section class="card">
      <h2>Unlock Progress</h2>
      <div class="row">
        <div class="progress-outer" style="flex:1">
          <div class="progress-inner" id="progressBar"></div>
        </div>
        <div class="status" id="progressPct">0%</div>
      </div>
      <div class="row small muted" style="margin-top:8px">
        Status: <strong id="lockStatus">Locked</strong>
        <span class="right"></span>
        <span class="muted">Next review: <span id="nextReview">‚Äî</span></span>
      </div>
      <details id="settings" style="margin-top:10px">
        <summary>Settings (Keyholder)</summary>
        <div class="row" style="margin-top:10px">
          <label>Progress % <input id="progressInput" type="number" min="0" max="100" step="1" value="0" style="width:92px"/></label>
          <label>Next review <input id="reviewInput" type="date"/></label>
          <label>Status 
            <select id="statusInput">
              <option>Locked</option>
              <option>Conditionally Unlocked</option>
              <option>Unlocked</option>
            </select>
          </label>
          <button id="saveSettings">Save</button>
        </div>
      </details>
    </section>

    <section class="card">
      <h2>Weekly Tasks</h2>
      <div class="tasks" id="taskList">
        <label class="task"><input type="checkbox" data-task="mon_dog"> Monday ‚Äî Healthy meal</label>
        <label class="task"><input type="checkbox" data-task="tue_meal"> Tuesday ‚Äî Walk Penny/Exercise</label>
        <label class="task"><input type="checkbox" data-task="wed_worship"> Wednesday ‚Äî Walk Penny/Exercise</label>
        <label class="task"><input type="checkbox" data-task="thu_meal"> Thursday ‚Äî Healthy meal</label>
        <label class="task"><input type="checkbox" data-task="fri_voice"> Friday ‚Äî Walk Penny/Exercise</label>
      </div>
    </section>

    <section class="card">
      <h2>Rules (Always in Effect)</h2>
      <ul class="rules" id="rulesList">
        <li>Always Obey.</li>
        <li>Send a Good Morning message to Your Keyholder with a picture of her dick.</li>
        <li>Show Me = Send Your Keyholder a picture of her dick and plug if on.</li>
        <li>If naked, send a picture during lunch.</li>
        <li>Sit when you pee.</li>
        <li>Vibrating plug must be on when going out.</li>
        <li>Plug must be on whenever leaving the apartment.</li>
        <li>Nightly message of devotion: "My Keyholder, this is your locked Pet submitting my nightly message with obedience and gratitude. I am Your Locked Pet. You are My Keyholder. My submission is yours. My pleasure is your will."</li>
        <li>No touching or unlocking without explicit permission.</li>
      </ul>
      <details id="editRules">
        <summary>Edit Rules (Keyholder)</summary>
        <textarea id="rulesEditor" placeholder="One rule per line"></textarea>
        <div class="row" style="margin-top:8px"><button id="saveRules">Save Rules</button></div>
      </details>
    </section>

    <section class="card" style="grid-column:1 / -1">
      <h2>üìù Notes</h2>
      <textarea id="notes" placeholder="Reflections, conditions, rewards, or reminders..."></textarea>
    </section>
  </div>

<script>
(function(){
  // ===== CONFIG: set these =====
  const REMOTE_URL = "https://script.google.com/macros/s/AKfycbyUAXcAvxgk1UHddSlXzvJgWxlVv-J0EZUf753MJrtXeWonzu4keL3GCR5U2qtkoT15/exec"; // Apps Script web app URL
  const KEYHOLDER_PIN = "IamtheKeyholder";               // UI gate only
  const SUB_PIN       = "herslave";                     // UI gate only
  const TOKEN_KEY     = "HisMaster";             // must match Apps Script
  const TOKEN_SUB     = "HerSlave";                   // must match Apps Script
  const AUTO_REFRESH_MS = 120000;                          // 2 minutes
  // ==============================

  // State & role
  let role = "viewer"; // viewer | keyholder | sub
  let state = {
    progress: 0, status: "Locked", nextReview: "",
    tasks: {}, rules: [], notes: "",
    calendar: {}, activity: []
  };

  // UI elements (matching your HTML)
  const serverMsg = document.getElementById("serverMsg");
  function flash(type, text){
    if(!serverMsg) return alert(text);
    serverMsg.className = "banner" + (type==="error" ? " error" : type==="success" ? " success" : "");
    serverMsg.textContent = text;
    serverMsg.style.display = "block";
    clearTimeout(flash._t); flash._t = setTimeout(()=>{ serverMsg.style.display="none"; }, 3000);
  }

  // Mode labels & buttons
  const modeLabel = document.getElementById("modeLabel");
  const keyBtn    = document.getElementById("toggleMode");   // existing "Keyholder Mode" button
  const subBtn    = document.getElementById("subModeBtn");   // renamed second button
  function setRole(r){
    role = r;
    if(modeLabel) modeLabel.textContent = r==="keyholder" ? "Keyholder" : r==="sub" ? "Locked Pet" : "Viewer";
    // Toggle editor UIs
    const settings = document.getElementById("settings");
    const editRules = document.getElementById("editRules");
    if(settings) settings.style.display = (r==="keyholder") ? "block" : "none";
    if(editRules) editRules.style.display = (r==="keyholder") ? "block" : "none";
  }
  if(keyBtn){
    keyBtn.addEventListener("click", ()=>{
      const pin = prompt("Enter Keyholder PIN:");
      if(pin !== KEYHOLDER_PIN){ return flash("error", "Wrong PIN"); }
      setRole("keyholder"); flash("", "Keyholder mode enabled");
    });
  }
  if(subBtn){
    subBtn.addEventListener("click", ()=>{
      const pin = prompt("Enter Sub PIN:");
      if(pin !== SUB_PIN){ return flash("error", "Wrong PIN"); }
      setRole("sub"); flash("", "Sub mode enabled");
    });
  }

  // DOM references used below
  const progressBar = document.getElementById("progressBar");
  const progressPct = document.getElementById("progressPct");
  const lockStatus  = document.getElementById("lockStatus");
  const nextReview  = document.getElementById("nextReview");
  const progressInput = document.getElementById("progressInput");
  const reviewInput   = document.getElementById("reviewInput");
  const statusInput   = document.getElementById("statusInput");
  const saveSettings  = document.getElementById("saveSettings");
  const rulesList     = document.getElementById("rulesList");
  const rulesEditor   = document.getElementById("rulesEditor");
  const saveRules     = document.getElementById("saveRules");
  const notesEl       = document.getElementById("notes");
  const taskList      = document.getElementById("taskList");

  // Calendar elements
  const monthLabel = document.getElementById("monthLabel");
  const dowRow     = document.getElementById("dowRow");
  const dayGrid    = document.getElementById("dayGrid");
  const prevBtn    = document.getElementById("prevBtn");
  const nextBtn    = document.getElementById("nextBtn");
  const DOW = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  if(dowRow && !dowRow.childElementCount){
    DOW.forEach(d=>{ const el=document.createElement("div"); el.className="dow"; el.textContent=d; dowRow.appendChild(el); });
  }
  let view = new Date(); view.setDate(1);
  function ymKey(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0"); }

  // ------ Remote I/O ------
  async function fetchShared(){
    const url = REMOTE_URL + "?v=" + Date.now();
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    return res.json();
  }
  async function postPatch(patch){
    const body = new URLSearchParams();
    body.set("token", role==="sub" ? TOKEN_SUB : TOKEN_KEY);
    body.set("who", role==="sub" ? "sub" : "keyholder");
    body.set("patch", JSON.stringify(patch));
    const res = await fetch(REMOTE_URL, {method:"POST", body});
    if(!res.ok) throw new Error("Save failed");
  }
  async function postStateFull(stateAll){
    const body = new URLSearchParams();
    body.set("token", TOKEN_KEY);
    body.set("who", "keyholder");
    body.set("state", JSON.stringify(stateAll));
    const res = await fetch(REMOTE_URL, {method:"POST", body});
    if(!res.ok) throw new Error("Save failed");
  }

  // ------ Render ------
  function buildMonth(){
    if(!dayGrid) return;
    dayGrid.innerHTML = "";
    const y=view.getFullYear(), m=view.getMonth();
    if(monthLabel) monthLabel.textContent = view.toLocaleString(undefined,{month:"long",year:"numeric"});
    const firstDow=new Date(y,m,1).getDay();
    const daysInMonth=new Date(y,m+1,0).getDate();
    for(let i=0;i<firstDow;i++){ const c=document.createElement("div"); c.className="cell"; dayGrid.appendChild(c); }
    const key = ymKey(view);
    const monthData = (state.calendar && state.calendar[key]) ? state.calendar[key] : {};
    for(let day=1; day<=daysInMonth; day++){
      const status = monthData[day] || "";
      const cell = document.createElement("div"); cell.className="cell"; cell.dataset.day=day;
      const num = document.createElement("div"); num.className="num"; num.textContent=day;
      const marks = document.createElement("div"); marks.className="marks";
      if(status){
        const chip=document.createElement("span"); chip.className="chip "+status;
        chip.textContent = status==="done"?"Done":status==="missed"?"Missed":status==="lock"?"Locked":status==="released"?"Released":"Unlocked";
        marks.appendChild(chip);
      }
      cell.appendChild(num); cell.appendChild(marks);
      // click handler: keyholder can cycle all; sub can set done/missed/clear
      cell.addEventListener("click", async ()=>{
        const orderKey = ["","done","missed","lock","released","unlocked"];
        const orderSub = ["","done","missed"];
        const order = (role==="keyholder") ? orderKey : (role==="sub" ? orderSub : null);
        if(!order) return flash("error","Choose a role to edit");
        const cur = monthData[day] || "";
        const idx = order.indexOf(cur);
        const next = order[(idx+1) % order.length];
        try{
          await postPatch({ calendarUpdate: { ym: ymKey(view), day, status: next } });
          // optimistic update
          if(!state.calendar) state.calendar = {};
          if(!state.calendar[ymKey(view)]) state.calendar[ymKey(view)] = {};
          state.calendar[ymKey(view)][day] = next;
          buildMonth(); flash("success","Saved");
        }catch(e){ flash("error", String(e)); }
      });
      dayGrid.appendChild(cell);
    }
  }

  function render(){
    // Progress & status
    if(progressBar){ progressBar.style.width = Math.max(0,Math.min(100,parseInt(state.progress||0,10))) + "%"; }
    if(progressPct){ progressPct.textContent = Math.max(0,Math.min(100,parseInt(state.progress||0,10))) + "%"; }
    if(lockStatus){ lockStatus.textContent = state.status || "Locked"; }
    if(nextReview){ nextReview.textContent = state.nextReview ? new Date(state.nextReview).toLocaleDateString() : "‚Äî"; }
    if(progressInput) progressInput.value = parseInt(state.progress||0,10) || 0;
    if(reviewInput) reviewInput.value = state.nextReview || "";
    if(statusInput) statusInput.value = state.status || "Locked";

    // Rules
    if(rulesList){
      rulesList.innerHTML = "";
      (state.rules||[]).forEach(r => { const li=document.createElement("li"); li.textContent=r; rulesList.appendChild(li); });
    }
    if(rulesEditor) rulesEditor.value = (state.rules||[]).join("\n");

    // Tasks
    if(taskList){
      taskList.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        const id = cb.dataset.task;
        cb.checked = !!(state.tasks && state.tasks[id]);
      });
    }

    // Notes
    if(notesEl){ notesEl.value = state.notes || ""; }

    // Calendar
    buildMonth();
  }

  // ------ Event bindings ------
  if(saveSettings){
    saveSettings.addEventListener("click", async ()=>{
      if(role!=="keyholder") return flash("error","Keyholder mode required");
      const next = {
        progress: Math.max(0, Math.min(100, parseInt(progressInput.value || "0", 10))),
        status: statusInput.value || "Locked",
        nextReview: reviewInput.value || "",
        rules: state.rules,
        notes: state.notes,
        tasks: state.tasks,
        calendar: state.calendar
      };
      try{ await postStateFull(next); Object.assign(state, next); render(); flash("success","Settings saved"); }
      catch(e){ flash("error", String(e)); }
    });
  }

  if(saveRules){
    saveRules.addEventListener("click", async ()=>{
      if(role!=="keyholder") return flash("error","Keyholder mode required");
      const arr = (rulesEditor.value || "").split(/\n/).map(s=>s.trim()).filter(Boolean);
      try{ await postPatch({ rules: arr }); state.rules = arr; render(); flash("success","Rules saved"); }
      catch(e){ flash("error", String(e)); }
    });
  }

  if(notesEl){
    notesEl.addEventListener("change", async ()=>{
      if(role!=="keyholder") return; // ignore viewer/sub changes to notes
      try{ await postPatch({ notes: notesEl.value || "" }); state.notes = notesEl.value || ""; flash("success","Notes saved"); }
      catch(e){ flash("error", String(e)); }
    });
  }

  if(taskList){
    taskList.addEventListener("change", async (e)=>{
      if(!e.target.matches('input[type="checkbox"]')) return;
      if(role!=="keyholder" && role!=="sub") return flash("error","Choose a role to save tasks");
      const map = {};
      taskList.querySelectorAll('input[type="checkbox"]').forEach(cb=> map[cb.dataset.task] = cb.checked );
      try{ await postPatch({ tasks: map }); state.tasks = Object.assign({}, state.tasks, map); flash("success","Tasks saved"); }
      catch(e){ flash("error", String(e)); }
    });
  }

  // Calendar nav
  if(prevBtn) prevBtn.addEventListener("click", ()=>{ view.setMonth(view.getMonth()-1); buildMonth(); });
  if(nextBtn) nextBtn.addEventListener("click", ()=>{ view.setMonth(view.getMonth()+1); buildMonth(); });

  // ------ Boot: fetch shared, then render ------
  (async function init(){
    try{
      const data = await fetchShared();
      state = Object.assign(state, data||{});
      render();
    }catch(e){
      flash("error", "Couldn't load shared data. Set REMOTE_URL and tokens.");
      render(); // render defaults so page still shows
    }
    setInterval(async ()=>{
      try{ const data = await fetchShared(); state = Object.assign(state, data||{}); render(); } catch(_){ /* ignore */ }
    }, AUTO_REFRESH_MS);
  })();
})();
</script>
</body>
</html>
