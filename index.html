<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Locked Pet's Dashboard</title>
<style>
  :root{
    --bg:#0f0f12;
    --card:#1a1a1f;
    --ink:#eaeaf0;
    --muted:#9aa0a6;
    --accent:#ff3366;
    --accent2:#cc0033;
    --ok:#22c55e;
    --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
    background:var(--bg);
    color:var(--ink);
    line-height:1.45;
  }
  header{
    padding:20px 16px;
    text-align:center;
    position:sticky;top:0;background:linear-gradient(0deg, rgba(15,15,18,0.2), var(--bg) 40%);
    z-index:10;
    border-bottom:1px solid #212129;
  }
  h1{margin:6px 0 0 0;font-size:1.4rem}
  .wrap{
    max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px;
    grid-template-columns:1fr;
  }
  @media(min-width:980px){
    .wrap{grid-template-columns:1.1fr 0.9fr;}
  }
  .card{
    background:var(--card);
    border:1px solid #23232b;
    border-radius:16px;
    padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,0.25);
  }
  .muted{color:var(--muted);font-size:0.9rem}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:4px 10px;border-radius:999px;background:#121219;border:1px solid #2a2a33}
  .progress-outer{
    width:100%;height:20px;border-radius:12px;background:#11131a;border:1px solid #2a2a33;overflow:hidden
  }
  .progress-inner{
    height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .35s;
  }
  .status{font-weight:600;margin-left:6px}
  button, input, textarea, select{
    background:#13131a;border:1px solid #2a2a33;color:var(--ink);
    border-radius:10px;padding:10px 12px;font-size:1rem
  }
  button{cursor:pointer}
  button:hover{filter:brightness(1.05)}
  textarea{width:100%;min-height:90px;resize:vertical}
  ul.rules{list-style:none;padding:0;margin:0;display:grid;gap:8px}
  ul.rules li{background:#13141b;border:1px solid #2a2a33;border-radius:10px;padding:10px 12px}
  .tasks{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .task{display:flex;gap:8px;align-items:center;background:#12131a;border:1px solid #2a2a33;border-radius:10px;padding:10px}
  .task input[type="checkbox"]{transform:scale(1.2)}
  /* Calendar */
  .cal{
    --g:12px;
    display:grid; gap:var(--g);
  }
  .cal header{position:unset;background:unset;border:none;padding:0;text-align:left}
  .cal .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .cal .bar h3{margin:0}
  .cal .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal .dow{color:var(--muted);text-align:center;font-size:0.85rem}
  .cal .cell{
    height:80px;background:#12131a;border:1px solid #2a2a33;border-radius:10px;padding:6px;
    display:flex;flex-direction:column;justify-content:space-between
  }
  .cal .num{font-weight:600;color:#d7d7de}
  .cal .marks{display:flex;gap:4px;flex-wrap:wrap}
  .chip{font-size:.75rem;border-radius:999px;padding:2px 6px;border:1px solid #2a2a33}
  .chip.done{background:rgba(34,197,94,.12);border-color:#214d33}
  .chip.missed{background:rgba(245,158,11,.12);border-color:#4d3a21}
  .chip.lock{background:rgba(255,51,102,.12);border-color:#4d1d2b}
  .time-since{font-variant-numeric:tabular-nums;font-weight:600}
  .activity{display:grid;gap:8px}
  .activity .item{background:#12131a;border:1px solid #2a2a33;border-radius:10px;padding:8px 10px;display:flex;gap:8px;align-items:center}
  .badge{font-size:.75rem;padding:2px 8px;border-radius:999px;border:1px solid #2a2a33}
  .badge.key{background:rgba(255,51,102,.12)}
  .badge.sub{background:rgba(34,197,94,.12)}
  .chip.released{background:rgba(96, 0, 250, 0.315);border-color:#0a0041}
  .chip.unlocked{background:rgb(57, 69, 240);border-color:#0016db}
  .center{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .small{font-size:.9rem}
  .right{margin-left:auto}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace;font-size:.85rem;background:#0e0e12;border:1px solid #2a2a33;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
  <header>
    <div class="row center">
      <div class="pill">Mode: <span id="modeLabel" class="status">Locked Pet</span></div>
      <button id="toggleMode" title="Enter a passphrase to enable Keyholder updates">Keyholder Mode</button>
      <button id="subModeBtn" >Locked Pet Mode</button>
    </div>
    <h1>Locked Pet's Dashboard</h1>
  </header>
<div id="serverMsg" class="banner" style="display:none;max-width:950px;margin:10px auto"></div>

  <!--div class="wrap" -->
    <!-- LEFT COLUMN -->
    <section class="card">
      <h2>Calendar</h2>
      <div class="muted small">Tap a day to mark: <span class="chip done">Done</span> / <span class="chip missed">Missed</span> / <span class="chip lock">Locked</span> / <span class="chip released">Released</span> / <span class="chip unlocked">Unlocked</span>.</div>
      <div class="cal" id="calendar">
        <div class="bar">
          <button id="prevBtn">‚Üê Prev</button>
          <h3 id="monthLabel">Month YYYY</h3>
          <button id="nextBtn">Next ‚Üí</button>
        </div>
        <div class="grid" id="dowRow"></div>
        <div class="grid" id="dayGrid"></div>
      </div>
    </section>

    <!-- RIGHT COLUMN -->
    <section class="card">
      <h2>Unlock Progress</h2>
      <div class="row">
        <div class="progress-outer" style="flex:1">
          <div class="progress-inner" id="progressBar"></div>
        </div>
        <div class="status" id="progressPct">0%</div>
      </div>
      <div class="row small muted" style="margin-top:8px">
        Status: <strong id="lockStatus">Locked</strong>
        <span class="right"></span>
        <span class="muted">Next review: <span id="nextReview">‚Äî</span></span>
      </div>
      <details id="settings" style="margin-top:10px">
        <summary>Settings (Keyholder)</summary>
        <div class="row" style="margin-top:10px">
          <label>Progress % <input id="progressInput" type="number" min="0" max="100" step="1" value="0" style="width:92px"/></label>
          <label>Next review <input id="reviewInput" type="date"/></label>
          <label>Status 
            <select id="statusInput">
              <option>Locked</option>
              <option>Conditionally Unlocked</option>
              <option>Unlocked</option>
            </select>
          </label>
          <button id="saveSettings">Save</button>
        </div>
      </details>
    </section>

    <!-- TIMER CARD -->
<section class="card" id="timerRoot" 
         data-remote="https://script.google.com/macros/s/AKfycbxnWSuWAO3S5Jt4ysHG8c2Dc4bMV2k3tFpoD_KRhG_IeHdUmxGLEjsM8RBD2ZyKNJhh/exec" 
         data-token-key="080692"
         data-token-sub="123091">
  <h2>Locked Timer</h2>
  <div id="timerDisplay" class="time-since" data-prefix="Locked for ">‚Äî</div>
  <div id="timerEditor" class="row" style="margin-top:8px; display:none">
    <label>Start
      <input id="timerInput" type="datetime-local">
    </label>
    <button id="timerSave">Save</button>
    <button id="timerClear">Clear</button>
  </div>
</section>

    <section class="card">
      <h2>Weekly Tasks</h2>
      <div class="tasks" id="taskList">
        <label class="task"><input type="checkbox" data-task="mon_dog"> Monday ‚Äî Healthy meal</label>
        <label class="task"><input type="checkbox" data-task="tue_meal"> Tuesday ‚Äî Walk Penny/Exercise</label>
        <label class="task"><input type="checkbox" data-task="wed_worship"> Wednesday ‚Äî Walk Penny/Exercise</label>
        <label class="task"><input type="checkbox" data-task="thu_meal"> Thursday ‚Äî Healthy meal</label>
        <label class="task"><input type="checkbox" data-task="fri_voice"> Friday ‚Äî Walk Penny/Exercise</label>
      </div>
    </section>

    <section class="card">
      <h2>Rules (Always in Effect)</h2>
      <ul class="rules" id="rulesList">
        <li>Always Obey.</li>
        <li>Send a Good Morning message to Your Keyholder with a picture of her dick.</li>
        <li>Show Me = Send Your Keyholder a picture of her dick and plug if on.</li>
        <li>If naked, send a picture during lunch.</li>
        <li>Sit when you pee.</li>
        <li>Vibrating plug must be on when going out.</li>
        <li>Plug must be on whenever leaving the apartment.</li>
        <li>Nightly message of devotion: "My Keyholder, this is your locked Pet submitting my nightly message with obedience and gratitude. I am Your Locked Pet. You are My Keyholder. My submission is yours. My pleasure is your will."</li>
        <li>No touching or unlocking without explicit permission.</li>
      </ul>
      <details id="editRules">
        <summary>Edit Rules (Keyholder)</summary>
        <textarea id="rulesEditor" placeholder="One rule per line"></textarea>
        <div class="row" style="margin-top:8px"><button id="saveRules">Save Rules</button></div>
      </details>
    </section>

    <section class="card" style="grid-column:1 / -1">
      <h2>üìù Notes</h2>
      <textarea id="notes" placeholder="Reflections, conditions, rewards, or reminders..."></textarea>
    </section>
  <!--/div -->

<script>
(function(){
  // ===== CONFIG: set these =====
  const REMOTE_URL    = "https://script.google.com/macros/s/AKfycbxnWSuWAO3S5Jt4ysHG8c2Dc4bMV2k3tFpoD_KRhG_IeHdUmxGLEjsM8RBD2ZyKNJhh/exec"; // Apps Script Web App URL (/exec)
  const KEYHOLDER_PIN = "IamtheKeyholder";                   // UI gate only
  const SUB_PIN       = "";                         // UI gate only
  const TOKEN_KEY     = "080692";                 // must match Apps Script
  const TOKEN_SUB     = "S123091";                       // must match Apps Script
  const AUTO_REFRESH_MS = 120000;                              // 2 minutes
  // ==============================

  const TAGS_KEYHOLDER = ["done","missed","lock","released","unlocked"];
  const TAGS_SUB       = ["done","missed"];

  // Render a YYYY-MM-DD string as local date (avoid UTC shift)
  function ymdToLocalDisplay(ymd){
    if(!ymd) return "‚Äî";
    const parts = ymd.split("-"); if(parts.length!==3) return ymd;
    const y = parseInt(parts[0],10), m = parseInt(parts[1],10), d = parseInt(parts[2],10);
    if(!y||!m||!d) return ymd;
    return new Date(y, m-1, d).toLocaleDateString();
  }

  // Timer helpers (local parsing)
  function parseLocalDateTime(s){
    if(!s) return null; s = String(s).trim();
    if(/[T ]\d{2}:\d{2}(:\d{2})?(Z|[+-]\d{2}:?\d{2})$/.test(s)) return new Date(s);
    s = s.replace(" ","T"); const [datePart, timePart] = s.split("T");
    const dparts = (datePart||"").split(/[-/]/).map(Number);
    const y=dparts[0]||0, m=(dparts[1]||1)-1, d=dparts[2]||1;
    let hh=0,mm=0,ss=0; if(timePart){ const t=timePart.split(":").map(Number); hh=t[0]||0; mm=t[1]||0; ss=t[2]||0; }
    return new Date(y,m,d,hh,mm,ss);
  }
  function diffParts(from,to){ let ms=Math.max(0,to-from); const D=86400000,H=3600000,M=60000,S=1000;
    const days=Math.floor(ms/D); ms%=D; const hours=Math.floor(ms/H); ms%=H; const minutes=Math.floor(ms/M); ms%=M; const seconds=Math.floor(ms/S);
    return {days,hours,minutes,seconds};
  }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function formatDiff(p, f){ f=(f||"dd hh:mm:ss").toLowerCase();
    return f.replace(/dd/g,String(p.days)).replace(/hh/g,pad2(p.hours)).replace(/mm/g,pad2(p.minutes)).replace(/ss/g,pad2(p.seconds)); }
  function toInputLocal(ymdHM){ if(!ymdHM) return ""; const s=String(ymdHM).replace("T"," ").replace(" ","T"); return s.slice(0,16); }

  // State & role
  let role = "viewer"; // viewer | keyholder | sub
  let state = { progress:0, status:"Locked", nextReview:"", tasks:{}, rules:[], notes:"", calendar:{}, activity:[], timerStart:"" };

  // UI elements
  const serverMsg = document.getElementById("serverMsg");
  function flash(type, text){
    if(!serverMsg) return alert(text);
    serverMsg.className = "banner" + (type==="error" ? " error" : type==="success" ? " success" : "");
    serverMsg.textContent = text; serverMsg.style.display = "block";
    clearTimeout(flash._t); flash._t = setTimeout(()=>{ serverMsg.style.display="none"; }, 3500);
  }

  // Role controls
  const modeLabel = document.getElementById("modeLabel");
  const keyBtn    = document.getElementById("toggleMode");
  const subBtn    = document.getElementById("subModeBtn");
  function setRole(r){
    role = r;
    if(modeLabel) modeLabel.textContent = r==="keyholder" ? "Keyholder" : r==="sub" ? "Locked Pet" : "Viewer";
    const settings = document.getElementById("settings");
    const editRules = document.getElementById("editRules");
    if(settings) settings.style.display = (r==="keyholder") ? "block" : "none";
    if(editRules) editRules.style.display = (r==="keyholder") ? "block" : "none";
    const timerEditor = document.getElementById("timerEditor");
    if(timerEditor) timerEditor.style.display = (r==="keyholder") ? "flex" : "none";
  }
  if(keyBtn){ keyBtn.addEventListener("click", ()=>{ const pin = prompt("Enter Keyholder PIN:"); if(pin!==KEYHOLDER_PIN) return flash("error","Wrong PIN"); setRole("keyholder"); flash("","Keyholder mode enabled"); }); }
  if(subBtn){ subBtn.addEventListener("click", ()=>{ const pin = prompt("Enter Sub PIN:"); if(pin!==SUB_PIN) return flash("error","Wrong PIN"); setRole("sub"); flash("","Sub mode enabled"); }); }

  // DOM refs
  const progressBar   = document.getElementById("progressBar");
  const progressPct   = document.getElementById("progressPct");
  const lockStatus    = document.getElementById("lockStatus");
  const nextReview    = document.getElementById("nextReview");
  const progressInput = document.getElementById("progressInput");
  const reviewInput   = document.getElementById("reviewInput");
  const statusInput   = document.getElementById("statusInput");
  const saveSettings  = document.getElementById("saveSettings");
  const rulesList     = document.getElementById("rulesList");
  const rulesEditor   = document.getElementById("rulesEditor");
  const saveRules     = document.getElementById("saveRules");
  const notesEl       = document.getElementById("notes");
  const taskList      = document.getElementById("taskList");
  const activityList  = document.getElementById("activityList");
  const timerDisplay  = document.getElementById("timerDisplay");
  const timerInput    = document.getElementById("timerInput");
  const timerSave     = document.getElementById("timerSave");
  const timerClear    = document.getElementById("timerClear");

  // Calendar
  const monthLabel = document.getElementById("monthLabel");
  const dowRow     = document.getElementById("dowRow");
  const dayGrid    = document.getElementById("dayGrid");
  const prevBtn    = document.getElementById("prevBtn");
  const nextBtn    = document.getElementById("nextBtn");
  const DOW = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  if(dowRow && !dowRow.childElementCount) DOW.forEach(d=>{ const el=document.createElement("div"); el.className="dow"; el.textContent=d; dowRow.appendChild(el); });
  let view = new Date(); view.setDate(1);
  function ymKey(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0"); }

  // Remote I/O
  async function fetchShared(){
    const res = await fetch(REMOTE_URL + "?v=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("GET failed: HTTP "+res.status);
    return res.json();
  }
  async function postPatch(patch){
    const body = new URLSearchParams();
    body.set("token", role==="sub" ? TOKEN_SUB : TOKEN_KEY);
    body.set("who", role==="sub" ? "sub" : "keyholder");
    body.set("patch", JSON.stringify(patch));
    const res = await fetch(REMOTE_URL, {method:"POST", body});
    let data=null; try{ data = await res.json(); }catch{}
    if(!res.ok || !data || data.ok!==true){
      const msg = data && data.error ? data.error : ("Save failed (HTTP "+res.status+")");
      throw new Error(msg);
    }
  }
  async function postStateFull(stateAll){
    const body = new URLSearchParams();
    body.set("token", TOKEN_KEY);
    body.set("who", "keyholder");
    body.set("state", JSON.stringify(stateAll));
    const res = await fetch(REMOTE_URL, {method:"POST", body});
    let data=null; try{ data = await res.json(); }catch{}
    if(!res.ok || !data || data.ok!==true){
      const msg = data && data.error ? data.error : ("Save failed (HTTP "+res.status+")");
      throw new Error(msg);
    }
  }

  // Activity render
  function renderActivity(items){
    if(!activityList) return;
    activityList.innerHTML = "";
    if(!items || !items.length){ const d=document.createElement("div"); d.className="muted"; d.textContent="No activity yet."; activityList.appendChild(d); return; }
    items.slice(-25).reverse().forEach(ev=>{
      const row = document.createElement("div"); row.className="item";
      const badge = document.createElement("span"); badge.className="badge " + (ev.who==="sub"?"sub":"key"); badge.textContent = ev.who==="sub"?"Sub":"Keyholder";
      const when = new Date(ev.when).toLocaleString();
      const detail = document.createElement("div"); detail.innerHTML = `<strong>${ev.type}</strong> ‚Äî ${ev.detail||''} <span class="muted">(${when})</span>`;
      row.appendChild(badge); row.appendChild(detail); activityList.appendChild(row);
    });
  }

  // Multi-tag calendar
  function chipsFor(tags){
    const arr = Array.isArray(tags) ? tags : (tags ? [tags] : []);
    const frag = document.createDocumentFragment();
    arr.forEach(tag=>{
      const chip=document.createElement("span"); chip.className="chip "+tag;
      chip.textContent = tag==="done"?"Done":tag==="missed"?"Missed":tag==="lock"?"Locked":tag==="released"?"Released":tag==="unlocked"?"Unlocked":tag;
      frag.appendChild(chip);
    });
    return frag;
  }
  function openTagPicker(cell, ym, day, current){
    if(role!=="keyholder" && role!=="sub"){ return flash("error","Choose a role to edit"); }
    const allowed = role==="keyholder" ? TAGS_KEYHOLDER : TAGS_SUB;
    const box = document.createElement("div");
    const r = cell.getBoundingClientRect();
    Object.assign(box.style, {position:"fixed", left:(r.left+window.scrollX)+"px", top:(r.bottom+window.scrollY+6)+"px",
      zIndex:9999, background:"#11131a", border:"1px solid #2a2a33", borderRadius:"10px", padding:"10px", boxShadow:"0 10px 30px rgba(0,0,0,0.45)"});
    box.innerHTML = `<div style="font-weight:600;margin-bottom:6px">Mark ${ym}-${day}</div>`;
    const list = document.createElement("div"); Object.assign(list.style, {display:"flex",gap:"10px",flexWrap:"wrap"});

    const cur = new Set(current);
    allowed.forEach(tag=>{
      const w = document.createElement("label"); Object.assign(w.style,{display:"flex",alignItems:"center",gap:"6px"});
      const cb = document.createElement("input"); cb.type="checkbox"; cb.checked = cur.has(tag);
      const chip = document.createElement("span"); chip.className="chip "+tag; chip.textContent = tag.charAt(0).toUpperCase()+tag.slice(1);
      w.appendChild(cb); w.appendChild(chip); list.appendChild(w);
      cb.addEventListener("change", ()=>{ if(cb.checked) cur.add(tag); else cur.delete(tag); });
    });
    box.appendChild(list);

    const row = document.createElement("div"); Object.assign(row.style,{display:"flex",gap:"8px",marginTop:"10px"});
    const save = document.createElement("button"); save.textContent = "Save"; 
    const cancel = document.createElement("button"); cancel.textContent = "Cancel";
    row.appendChild(save); row.appendChild(cancel); box.appendChild(row);
    document.body.appendChild(box);

    function cleanup(){ box.remove(); document.removeEventListener("click", onDoc); }
    function onDoc(e){ if(!box.contains(e.target)) cleanup(); }
    setTimeout(()=>document.addEventListener("click", onDoc), 0);

    save.addEventListener("click", async ()=>{
      const tags = Array.from(cur);
      try{
        await postPatch({ calendarSet: { ym, day, tags } });
        if(!state.calendar) state.calendar = {};
        if(!state.calendar[ym]) state.calendar[ym] = {};
        state.calendar[ym][day] = tags;
        buildMonth(); flash("success","Saved");
      }catch(e){ flash("error", String(e)); }
      cleanup();
    });
    cancel.addEventListener("click", cleanup);
  }
  function buildMonth(){
    if(!dayGrid) return;
    dayGrid.innerHTML = "";
    const y=view.getFullYear(), m=view.getMonth();
    if(monthLabel) monthLabel.textContent = view.toLocaleString(undefined,{month:"long",year:"numeric"});
    const firstDow=new Date(y,m,1).getDay();
    const daysInMonth=new Date(y,m+1,0).getDate();
    for(let i=0;i<firstDow;i++){ const c=document.createElement("div"); c.className="cell"; dayGrid.appendChild(c); }
    const key = ymKey(view);
    const monthData = (state.calendar && state.calendar[key]) ? state.calendar[key] : {};
    for(let day=1; day<=daysInMonth; day++){
      const val = monthData[day] || [];
      const cell = document.createElement("div"); cell.className="cell"; cell.dataset.day=day;
      const num = document.createElement("div"); num.className="num"; num.textContent=day;
      const marks = document.createElement("div"); marks.className="marks"; marks.appendChild(chipsFor(val));
      cell.appendChild(num); cell.appendChild(marks);
      cell.addEventListener("click", ()=>{
        const current = Array.isArray(val) ? val : (val ? [val] : []);
        openTagPicker(cell, key, day, current);
      });
      dayGrid.appendChild(cell);
    }
  }

  // Render
  let timerInterval=null;
  function render(){
    const pct = Math.max(0,Math.min(100,parseInt(state.progress||0,10)));
    if(progressBar) progressBar.style.width = pct + "%";
    if(progressPct) progressPct.textContent = pct + "%";
    if(lockStatus) lockStatus.textContent = state.status || "Locked";
    if(nextReview) nextReview.textContent = state.nextReview ? ymdToLocalDisplay(state.nextReview) : "‚Äî";
    if(progressInput) progressInput.value = pct;
    if(reviewInput) reviewInput.value = state.nextReview || "";
    if(statusInput) statusInput.value = state.status || "Locked";

    if(rulesList){ rulesList.innerHTML = ""; (state.rules||[]).forEach(r => { const li=document.createElement("li"); li.textContent=r; rulesList.appendChild(li); }); }
    if(rulesEditor) rulesEditor.value = (state.rules||[]).join("\n");

    if(taskList){
      taskList.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        const id = cb.dataset.task; cb.checked = !!(state.tasks && state.tasks[id]);
      });
    }

    if(notesEl) notesEl.value = state.notes || "";
    // Timer
    const timerEditor = document.getElementById("timerEditor");
    if(timerEditor) timerEditor.style.display = (role==="keyholder") ? "flex" : "none";
    if(timerInput) timerInput.value = toInputLocal(state.timerStart||"");
    if(timerDisplay){
      clearInterval(timerInterval);
      const start = parseLocalDateTime(state.timerStart||"");
      if(!start) timerDisplay.textContent = "‚Äî";
      else{
        const tick=()=>{ const p=diffParts(start,new Date()); timerDisplay.textContent = (timerDisplay.getAttribute("data-prefix")||"") + formatDiff(p, "dd hh:mm:ss"); };
        tick(); timerInterval = setInterval(tick, 1000);
      }
    }

    buildMonth();
    renderActivity(state.activity || []);
  }

  // Events
  if(saveSettings){
    saveSettings.addEventListener("click", async ()=>{
      if(role!=="keyholder") return flash("error","Keyholder mode required");
      const next = {
        progress: Math.max(0, Math.min(100, parseInt(progressInput.value || "0", 10))),
        status: statusInput.value || "Locked",
        nextReview: reviewInput.value || "",
        rules: state.rules, notes: state.notes, tasks: state.tasks, calendar: state.calendar, timerStart: state.timerStart||""
      };
      try{ await postStateFull(next); Object.assign(state, next); flash("success","Settings saved"); }
      catch(e){ flash("error", String(e)); }
    });
  }
  if(saveRules){
    saveRules.addEventListener("click", async ()=>{
      if(role!=="keyholder") return flash("error","Keyholder mode required");
      const arr = (rulesEditor.value || "").split(/\n/).map(s=>s.trim()).filter(Boolean);
      try{ await postPatch({ rules: arr }); state.rules = arr; flash("success","Rules saved"); }
      catch(e){ flash("error", String(e)); }
    });
  }
  if(notesEl){
    notesEl.addEventListener("change", async ()=>{
      if(role!=="keyholder") return; // ignore non-keyholder
      try{ await postPatch({ notes: notesEl.value || "" }); state.notes = notesEl.value || ""; flash("success","Notes saved"); }
      catch(e){ flash("error", String(e)); }
    });
  }
  if(taskList){
    taskList.addEventListener("change", async (e)=>{
      if(!e.target.matches('input[type="checkbox"]')) return;
      if(role!=="keyholder" && role!=="sub") return flash("error","Choose a role to save tasks");
      const map = {}; taskList.querySelectorAll('input[type="checkbox"]').forEach(cb=> map[cb.dataset.task] = cb.checked );
      try{ await postPatch({ tasks: map }); state.tasks = Object.assign({}, state.tasks, map); flash("success","Tasks saved"); }
      catch(e){ flash("error", String(e)); }
    });
  }
  if(prevBtn) prevBtn.addEventListener("click", ()=>{ view.setMonth(view.getMonth()-1); buildMonth(); });
  if(nextBtn) nextBtn.addEventListener("click", ()=>{ view.setMonth(view.getMonth()+1); buildMonth(); });

  if(timerSave){
    timerSave.addEventListener("click", async ()=>{
      if(role!=="keyholder") return flash("error","Keyholder mode required");
      const v = (timerInput.value||"").replace("T"," ").slice(0,16);
      try{ await postPatch({ timerStart: v }); state.timerStart = v; render(); flash("success","Timer saved"); }
      catch(e){ flash("error", String(e)); }
    });
  }
  if(timerClear){
    timerClear.addEventListener("click", async ()=>{
      if(role!=="keyholder") return flash("error","Keyholder mode required");
      try{ await postPatch({ timerStart: "" }); state.timerStart = ""; render(); flash("success","Timer cleared"); }
      catch(e){ flash("error", String(e)); }
    });
  }

  // Boot
  (async function init(){
    try{ const data = await fetchShared(); state = Object.assign(state, data||{}); } catch(e){ flash("error","GET failed. Check REMOTE_URL & deployment access = Anyone."); }
    render();
    setInterval(async ()=>{ try{ const data = await fetchShared(); state = Object.assign(state, data||{}); render(); } catch(_){ } }, AUTO_REFRESH_MS);
  })();
})();

(function(){
  // ---- Timer module (standalone) ----
  // Looks for these elements if present:
  //   #timerDisplay  -- shows "Locked for dd hh:mm:ss"
  //   #timerEditor   -- editor row (visible for Keyholder only)
  //   #timerInput    -- <input type="datetime-local">
  //   #timerSave     -- button to save
  //   #timerClear    -- button to clear
  //
  // Reads/writes `timerStart` from your Apps Script backend.
  // Tries to use global REMOTE_URL and tokens, else falls back to data-* on #timerRoot.

  function parseLocalDateTime(s){
    if(!s) return null; s = String(s).trim();
    if(/[T ]\d{2}:\d{2}(:\d{2})?(Z|[+-]\d{2}:?\d{2})$/.test(s)) return new Date(s);
    s = s.replace(' ', 'T'); const [datePart,timePart] = s.split('T');
    const dparts = (datePart||'').split(/[-/]/).map(Number);
    const y = dparts[0]||0, m=(dparts[1]||1)-1, d=dparts[2]||1;
    let hh=0,mm=0,ss=0; if(timePart){ const t=timePart.split(':').map(Number); hh=t[0]||0; mm=t[1]||0; ss=t[2]||0; }
    return new Date(y,m,d,hh,mm,ss);
  }
  function diffParts(from,to){ let ms=Math.max(0,to-from); const D=86400000,H=3600000,M=60000,S=1000;
    const days=Math.floor(ms/D); ms%=D; const hours=Math.floor(ms/H); ms%=H; const minutes=Math.floor(ms/M); ms%=M; const seconds=Math.floor(ms/S);
    return {days,hours,minutes,seconds}; }
  function pad2(n){ return String(n).padStart(2,'0'); }
  function formatDiff(p,fmt){ fmt=(fmt||'dd hh:mm:ss').toLowerCase();
    return fmt.replace(/dd/g,String(p.days)).replace(/hh/g,pad2(p.hours)).replace(/mm/g,pad2(p.minutes)).replace(/ss/g,pad2(p.seconds)); }
  function toInputLocal(ymdHM){ if(!ymdHM) return ''; const s=String(ymdHM).replace('T',' ').replace(' ','T'); return s.slice(0,16); }

  function getConfig(){
    const root = document.getElementById('timerRoot');
    return {
      REMOTE_URL: (window.REMOTE_URL || (root && root.dataset.remote) || '').trim(),
      TOKEN_KEY: (window.TOKEN_KEY || (root && root.dataset.tokenKey) || '').trim(),
      TOKEN_SUB: (window.TOKEN_SUB || (root && root.dataset.tokenSub) || '').trim()
    };
  }

  async function fetchShared(url){
    const res = await fetch(url + '?v=' + Date.now(), {cache:'no-store'});
    if(!res.ok) throw new Error('GET failed: HTTP '+res.status);
    return res.json();
  }
  async function postPatch(url, token, patch){
    const body = new URLSearchParams();
    body.set('token', token);
    body.set('who', 'keyholder');
    body.set('patch', JSON.stringify(patch));
    const res = await fetch(url, {method:'POST', body});
    let data=null; try{ data = await res.json(); }catch{}
    if(!res.ok || !data || data.ok!==true){
      const msg = data && data.error ? data.error : ('Save failed (HTTP '+res.status+')');
      throw new Error(msg);
    }
  }

  function boot(){
    const disp = document.getElementById('timerDisplay');
    const editRow = document.getElementById('timerEditor');
    const input = document.getElementById('timerInput');
    const btnSave = document.getElementById('timerSave');
    const btnClear = document.getElementById('timerClear');
    if(!disp) return;

    const cfg = getConfig();
    let interval = null, timerStart = '';

    function setEditorVisibility(){
      const modeLabel = document.getElementById('modeLabel');
      const isKeyholder = (modeLabel && modeLabel.textContent==='Keyholder');
      if(editRow) editRow.style.display = isKeyholder ? 'flex' : 'none';
    }

    function render(){
      clearInterval(interval);
      const start = parseLocalDateTime(timerStart||'');
      if(!start){ disp.textContent = '‚Äî'; return; }
      const tick = ()=>{
        const p = diffParts(start, new Date());
        const prefix = disp.getAttribute('data-prefix') || '';
        disp.textContent = prefix + formatDiff(p, 'dd hh:mm:ss');
      };
      tick();
      interval = setInterval(tick, 1000);
    }

    async function sync(){
      if(!cfg.REMOTE_URL){ disp.textContent = 'Set REMOTE_URL (or data-remote on #timerRoot)'; return; }
      const data = await fetchShared(cfg.REMOTE_URL);
      timerStart = (data && data.timerStart) || '';
      if(input) input.value = toInputLocal(timerStart);
      render(); setEditorVisibility();
    }

    if(btnSave){
      btnSave.addEventListener('click', async ()=>{
        const modeLabel = document.getElementById('modeLabel');
        if(!(modeLabel && modeLabel.textContent==='Keyholder')) return alert('Keyholder mode required');
        const v = (input.value||'').replace('T',' ').slice(0,16);
        await postPatch(cfg.REMOTE_URL, cfg.TOKEN_KEY, { timerStart: v });
        timerStart = v; render();
      });
    }
    if(btnClear){
      btnClear.addEventListener('click', async ()=>{
        const modeLabel = document.getElementById('modeLabel');
        if(!(modeLabel && modeLabel.textContent==='Keyholder')) return alert('Keyholder mode required');
        await postPatch(cfg.REMOTE_URL, cfg.TOKEN_KEY, { timerStart: '' });
        timerStart = ''; render();
      });
    }

    // initial sync + keep in step if your page already re-syncs globally
    sync().catch(e=>{ disp.textContent = String(e.message||e); });
    document.addEventListener('click', (e)=>{
      if(e.target && (e.target.id==='toggleMode' || e.target.id==='subModeBtn')){
        setTimeout(setEditorVisibility, 50);
      }
    });
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
})();
</script>
<script src="timer_module.js"></script>

<!-- Optional: add this style once to make numbers align nicely -->
<style>.time-since{font-variant-numeric:tabular-nums;font-weight:600}</style>
</body>
</html>
